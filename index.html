<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Group Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }
      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }
      .tabs {
        display: flex;
        background: white;
        border-radius: 15px 15px 0 0;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .tab {
        flex: 1;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        border: none;
        font-size: 1.1rem;
      }
      .tab.active {
        background: white;
        color: #667eea;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
      }
      .tab:hover:not(.active) {
        background: #e9ecef;
      }
      .tab-content {
        background: white;
        border-radius: 0 0 15px 15px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        min-height: 600px;
      }
      .tab-pane {
        display: none;
      }
      .tab-pane.active {
        display: block;
      }
      .action-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        align-items: center;
      }
      .action-group {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .action-group label {
        font-weight: 500;
        color: #666;
        margin-right: 10px;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-family: "Poppins", sans-serif;
        text-decoration: none;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .btn-primary {
        background: #667eea;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      .btn-secondary {
        background: #6c757d;
        color: white;
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 0.875rem;
      }
      .search-container {
        margin-bottom: 20px;
      }
      .search-input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        font-family: "Poppins", sans-serif;
      }
      .search-input:focus {
        outline: none;
        border-color: #667eea;
      }
      .student-list,
      .group-container {
        border-radius: 10px;
        padding-top: 20px;
        transition: all 0.4s ease-in-out;
      }
      .student-item,
      .member-item {
        display: flex;
        align-items: center;
        padding: 15px;
        background: white;
        margin-bottom: 10px;
        border-radius: 8px;
        transition: all 0.3s ease;
        cursor: pointer;
        border: 1px solid #e9ecef;
      }
      .student-item:hover,
      .member-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .student-item.selected,
      .member-item.selected {
        background: #e3f2fd;
        border-left: 4px solid #667eea;
        padding-left: 11px;
      }
      .student-checkbox {
        display: none;
        visibility: hidden;
        margin-right: 15px;
        transform: scale(1.2);
      }
      .student-info {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .student-roll {
        font-weight: 500;
        color: #333;
      }
      .student-name {
        color: #666;
        font-size: 1rem;
      }
      .student-serial {
        font-weight: 600;
        color: #667eea;
        font-size: 1rem;
        width: 30px;
        text-align: center;
        margin-right: 15px;
      }
      .group-card {
        background: white;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .group-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .group-header {
        padding: 20px;
        background: #f8f9fa;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
      }
      .group-info h3 {
        margin-bottom: 5px;
        font-size: 1.3rem;
        color: #667eea;
      }
      .group-stats {
        font-size: 0.9rem;
        opacity: 0.9;
      }
      .group-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .group-body {
        padding: 20px;
        display: none;
        background: white;
      }
      .group-body.expanded {
        display: block;
      }
      .marker-buttons {
        display: flex;
        gap: 5px;
        margin-left: auto;
        margin-right: 15px;
      }
      .marker-btn {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #e9ecef;
      }
      .marker-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
      .marker-btn.active {
        background: #667eea;
        color: white;
      }
      .marker-btn-clear {
        background: #f1f1f1;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-header h3 {
        color: #333;
        font-size: 1.5rem;
      }
      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #666;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }
      .form-control {
        width: 100%;
        padding: 12px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
        font-family: "Poppins", sans-serif;
      }
      .form-control:focus {
        outline: none;
        border-color: #667eea;
      }
      .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1100;
      }
      .toast {
        background: #333;
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        min-width: 300px;
        animation: slideIn 0.3s ease;
      }
      .toast .undo-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        font-weight: 600;
        cursor: pointer;
      }
      @keyframes slideIn {
        from {
          transform: translateX(120%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      .dropdown-select {
        padding: 10px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-family: "Poppins", sans-serif;
        min-width: 150px;
      }
      .dropdown-select:focus {
        outline: none;
        border-color: #667eea;
      }
      .radio-group {
        display: flex;
        gap: 20px;
        margin: 15px 0;
      }
      .radio-item,
      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .checkbox-group {
        margin: 15px 0;
      }
      .hidden {
        display: none !important;
      }
      .collapsed {
        max-height: 0;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
        overflow: hidden;
      }
      .text-center {
        text-align: center;
      }
      .text-muted {
        color: #6c757d;
      }
      .page-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }
      .page-section-header h2 {
        margin-bottom: 0;
      }
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        .header h1 {
          font-size: 2rem;
        }
        .tab-content {
          padding: 15px;
        }
        .action-bar {
          flex-direction: column;
          align-items: stretch;
        }
        .action-group {
          flex-direction: column;
          align-items: stretch;
        }
        .action-group .btn {
          justify-content: center;
        }
        .group-header {
          flex-direction: column;
          text-align: center;
        }
        .group-actions {
          justify-content: center;
        }
        .member-item {
          display: flex;
          flex-direction: row; /* default, so you can also omit this */
          align-items: flex-start; /* aligns items to the top */
          justify-content: flex-start; /* aligns items to the left */
          gap: 10px;
        }
        .marker-buttons {
          margin-left: 0;
          width: 100%;
          justify-content: space-around;
        }
        .member-item .btn-danger {
          width: 100%;
          justify-content: center;
          margin-top: 10px;
        }
        .modal-content {
          padding: 20px;
          margin: 10px;
        }
        .toast {
          min-width: 250px;
          margin-right: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1><i class="fas fa-users-cog"></i> Student Group Manager</h1>
        <p>Organize students into groups with ease</p>
      </header>

      <nav class="tabs">
        <button class="tab active" onclick="showTab('students', this)">
          <i class="fas fa-graduation-cap"></i> Students
        </button>
        <button class="tab" onclick="showTab('groups', this)">
          <i class="fas fa-layer-group"></i> Groups
        </button>
      </nav>

      <main class="tab-content">
        <div id="students-tab" class="tab-pane active">
          <section class="action-bar">
            <div class="action-group">
              <label>Student Actions:</label>
              <button class="btn btn-primary" onclick="openStudentModal()">
                <i class="fas fa-plus"></i> Add
              </button>
              <button class="btn btn-primary" onclick="openBulkAddModal()">
                <i class="fas fa-file-import"></i> Bulk Add
              </button>
              <button class="btn btn-warning" onclick="openRandomizeModal()">
                <i class="fas fa-random"></i> Random
              </button>
              <button
                class="btn btn-secondary"
                onclick="toggleSelectAllStudents()"
              >
                <i class="fas fa-check-square"></i> Select All
              </button>
              <button class="btn btn-danger" onclick="deleteSelectedStudents()">
                <i class="fas fa-trash"></i> Delete
                <span id="selectedCount">(0)</span>
              </button>
            </div>
          </section>
          <section class="action-bar">
            <div class="action-group" style="width: 100%">
              <label>Assignment:</label>
              <select
                id="groupSelect"
                class="dropdown-select"
                style="flex-grow: 1"
              ></select>
              <button class="btn btn-success" onclick="assignSelectedToGroup()">
                <i class="fas fa-arrow-right"></i> Assign to Group
              </button>
            </div>
          </section>
          <section class="action-bar">
            <div class="action-group">
              <label>Data:</label>
              <button
                class="btn btn-secondary"
                onclick="exportSelectedStudents()"
              >
                <i class="fas fa-download"></i> Export
              </button>
              <button class="btn btn-secondary" onclick="backupAllData()">
                <i class="fas fa-save"></i> Backup All
              </button>
              <input
                type="file"
                id="restore-input"
                accept=".json"
                style="display: none"
                onchange="restoreData(event)"
              />
              <button
                class="btn btn-secondary"
                onclick="document.getElementById('restore-input').click()"
              >
                <i class="fas fa-upload"></i> Restore
              </button>
            </div>
          </section>
          <section class="page-section-header">
            <h2><i class="fas fa-list"></i> All Students</h2>
            <button
              class="btn btn-sm btn-secondary"
              onclick="toggleCollapse('studentListContainer')"
            >
              <i class="fas fa-compress-alt"></i> Toggle List
            </button>
          </section>
          <div id="studentListContainer">
            <section class="search-container">
              <input
                type="text"
                id="searchStudent"
                class="search-input"
                placeholder="Search students by name or roll number..."
              />
            </section>
            <section id="studentList" class="student-list"></section>
          </div>
        </div>

        <div id="groups-tab" class="tab-pane">
          <section class="action-bar">
            <div class="action-group" style="flex-grow: 1">
              <input
                type="text"
                id="newGroupName"
                class="form-control"
                placeholder="Enter new group name..."
                style="flex-grow: 1"
              />
              <button class="btn btn-primary" onclick="createGroup()">
                <i class="fas fa-plus"></i> Create Group
              </button>
            </div>
          </section>
          <section class="page-section-header">
            <h2><i class="fas fa-layer-group"></i> All Groups</h2>
            <button
              class="btn btn-sm btn-secondary"
              onclick="toggleAllGroupBodies()"
            >
              <i class="fas fa-compress-alt"></i> Toggle All
            </button>
          </section>
          <section id="groupListContainer" class="group-container"></section>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <div id="studentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalTitle">Add New Student</h3>
          <button class="close-btn" onclick="closeStudentModal()">×</button>
        </div>
        <input type="hidden" id="editingRoll" />
        <div class="form-group">
          <label for="studentRoll">Roll Number</label>
          <input type="text" id="studentRoll" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="studentName">Full Name</label>
          <input type="text" id="studentName" class="form-control" required />
        </div>
        <div class="text-center">
          <button class="btn btn-primary" onclick="saveStudent()">
            Save Student
          </button>
        </div>
      </div>
    </div>
    <div id="bulkAddModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Bulk Add Students</h3>
          <button class="close-btn" onclick="closeBulkAddModal()">×</button>
        </div>
        <div class="form-group">
          <label for="bulkStudentData">Paste JSON Array of Students</label>
          <textarea
            id="bulkStudentData"
            class="form-control"
            rows="10"
            placeholder='[{"roll": "123", "name": "John Doe"}]'
          ></textarea>
        </div>
        <div class="text-center">
          <button class="btn btn-primary" onclick="importBulkStudents()">
            Import Students
          </button>
        </div>
      </div>
    </div>
    <div id="randomizeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Random Group Generator</h3>
          <button class="close-btn" onclick="closeRandomizeModal()">×</button>
        </div>
        <div class="form-group">
          <label>Group Creation Method:</label>
          <div class="radio-group">
            <div class="radio-item">
              <input
                type="radio"
                id="byNumGroups"
                name="randomizeMethod"
                value="numGroups"
                checked
                onchange="updateRandomizeLabel()"
              />
              <label for="byNumGroups">Number of Groups</label>
            </div>
            <div class="radio-item">
              <input
                type="radio"
                id="byStudentsPerGroup"
                name="randomizeMethod"
                value="studentsPerGroup"
                onchange="updateRandomizeLabel()"
              />
              <label for="byStudentsPerGroup">Students per Group</label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label id="randomizeValueLabel" for="randomizeValue"
            >Number of Groups:</label
          >
          <input
            type="number"
            id="randomizeValue"
            class="form-control"
            min="1"
            value="2"
          />
        </div>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="includeAssigned" />
            <label for="includeAssigned"
              >Include students already in a group</label
            >
          </div>
        </div>
        <div class="text-center">
          <button class="btn btn-warning" onclick="generateRandomGroups()">
            Generate Groups
          </button>
        </div>
      </div>
    </div>
    <div id="toast-container" class="toast-container"></div>

    <script>
      // --- JAVASCRIPT LOGIC FROM OUR MAIN PROJECT ---
      let allStudents = [];
      let allGroups = {};
      let selectedStudentRolls = new Set();
      const MARKER_OPTIONS = ["✅","❌"];
      let undoState = null;
      let undoTimeout = null;
      let openGroups = new Set();

      function saveToStorage() {
        localStorage.setItem("students", JSON.stringify(allStudents));
        localStorage.setItem("groups", JSON.stringify(allGroups));
      }
      function loadFromStorage() {
        allStudents = JSON.parse(localStorage.getItem("students") || "[]");
        allGroups = JSON.parse(localStorage.getItem("groups") || "{}");
        Object.values(allGroups).forEach((group) => {
          group.forEach((member) => {
            if (member.marker === undefined) member.marker = "";
          });
        });
      }
      function refreshAll() {
        saveToStorage();
        renderStudents();
        renderGroups();
        updateAssignmentDropdown();
      }

      function clearUndoState() {
        clearTimeout(undoTimeout);
        undoState = null;
      }
      function showToast(message, undoCallback = null) {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = "toast";
        const messageSpan = document.createElement("span");
        messageSpan.innerHTML = `<i class="fas fa-info-circle" style="margin-right: 10px;"></i> ${message}`;
        toast.appendChild(messageSpan);
        if (undoCallback) {
          const undoBtn = document.createElement("button");
          undoBtn.className = "undo-btn";
          undoBtn.textContent = "Undo";
          undoBtn.onclick = () => {
            undoCallback();
            toast.remove();
          };
          toast.appendChild(undoBtn);
        }
        container.appendChild(toast);
        const duration = undoCallback ? 7000 : 4000;
        setTimeout(() => {
          if (toast.parentElement) toast.remove();
        }, duration);
      }
      function performUndo() {
        if (!undoState) return;
        switch (undoState.type) {
          case "students":
            allStudents.push(...undoState.data.students);
            allStudents.sort((a, b) =>
              a.roll.localeCompare(b.roll, undefined, { numeric: true })
            );
            allGroups = undoState.data.groups;
            selectedStudentRolls.clear();
            break;
          case "group":
            allGroups[undoState.data.name] = undoState.data.members;
            break;
          case "members":
            const group = allGroups[undoState.data.groupName];
            if (group) {
              group.push(...undoState.data.members);
              group.sort((a, b) =>
                a.roll.localeCompare(b.roll, undefined, { numeric: true })
              );
            }
            break;
        }
        showToast("Action has been undone.");
        clearUndoState();
        refreshAll();
      }

      function renderStudents() {
        const container = document.getElementById("studentList");
        const query = document
          .getElementById("searchStudent")
          .value.toLowerCase();
        const filteredStudents = allStudents.filter(
          (s) =>
            s.name.toLowerCase().includes(query) ||
            s.roll.toLowerCase().includes(query)
        );
        if (filteredStudents.length === 0) {
          container.innerHTML =
            '<div class="text-center text-muted" style="padding-top: 20px;"><h3>No students found.</h3></div>';
          updateSelectedCount();
          return;
        }
        container.innerHTML = filteredStudents
          .map(
            (s, i) => `
                <div class="student-item ${
                  selectedStudentRolls.has(s.roll) ? "selected" : ""
                }" onclick="toggleStudentSelection('${s.roll}')">
                    <input type="checkbox" class="student-checkbox" data-roll="${
                      s.roll
                    }" onchange="handleStudentSelectionChange(event, '${
              s.roll
            }')" ${
              selectedStudentRolls.has(s.roll) ? "checked" : ""
            } onclick="event.stopPropagation()">
             
                    <div class="student-serial">#${i + 1}</div>
                    <div class="student-info">
                        <div class="student-roll">${s.roll}</div>
                        <div class="student-name">${s.name}</div>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); editStudent('${
                      s.roll
                    }')"><i class="fas fa-edit"></i> Edit</button>
                </div>
            `
          )
          .join("");
        updateSelectedCount();
      }

      function renderGroups() {
        const container = document.getElementById("groupListContainer");
        const groupKeys = Object.keys(allGroups).sort();
        if (groupKeys.length === 0) {
          container.innerHTML =
            '<div class="text-center text-muted" style="padding-top: 20px;"><h3>No groups created.</h3></div>';
          return;
        }
        container.innerHTML = groupKeys
          .map((groupName) => {
            const members = allGroups[groupName];
            const isExpanded = openGroups.has(groupName);
            const selectedInGroup = members.filter((m) =>
              selectedStudentRolls.has(m.roll)
            );
            const memberHTML = members
              .map(
                (m, i) => `
                    <div class="member-item ${
                      selectedStudentRolls.has(m.roll) ? "selected" : ""
                    }" onclick="toggleStudentSelection('${m.roll}')">
                        <input type="checkbox" class="student-checkbox" data-roll="${
                          m.roll
                        }" onchange="handleStudentSelectionChange(event, '${
                  m.roll
                }')" ${
                  selectedStudentRolls.has(m.roll) ? "checked" : ""
                } onclick="event.stopPropagation()">
                        <div class="student-serial">#${i + 1}</div>
                        <div class="student-info">
                            <div class="student-roll">${m.roll}</div>
                            <div class="student-name">${m.name}</div>
                        </div>
                        <div class="marker-buttons">
                            ${MARKER_OPTIONS.map(
                              (marker) =>
                                `<button class="marker-btn ${
                                  m.marker === marker ? "active" : ""
                                }" onclick="event.stopPropagation(); setMarker('${groupName}', '${
                                  m.roll
                                }', '${marker}')">${marker}</button>`
                            ).join("")}
                            <button class="marker-btn marker-btn-clear" onclick="event.stopPropagation(); setMarker('${groupName}', '${
                  m.roll
                }', '')" title="Clear marker">🗡</button>
                        </div>
                        
                    </div>`
              )
              .join("");
            const moveOptionsHTML = Object.keys(allGroups)
              .filter((g) => g !== groupName)
              .map((g) => `<option value="${g}">${g}</option>`)
              .join("");
            return `
                    <div class="group-card">
                        <div class="group-header" onclick="toggleGroupBody('${groupName}')">
                            <div class="group-info">
                                <h3>${groupName}</h3>
                                <div class="group-stats">${
                                  members.length
                                } members <span id="group-selected-count-${groupName}">(${
              selectedInGroup.length
            } selected)</span></div>
                            </div>
                            <div class="group-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-sm btn-secondary" onclick="toggleSelectAllInGroup('${groupName}')"><i class="fas fa-check-square"></i> Select All</button>
                                <button class="btn btn-sm btn-primary" onclick="exportGroup('${groupName}')"><i class="fas fa-download"></i> Export</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteGroup('${groupName}')"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </div>
                        <div class="group-body ${isExpanded ? "expanded" : ""}">
                            <div class="action-bar" style="padding: 10px; margin-bottom: 10px; background: #fff;">
                                <button class="btn btn-danger" onclick="removeSelectedMembers('${groupName}')"><i class="fas fa-user-minus"></i> Remove Selected</button>
                                <select id="move-group-select-${groupName}" class="dropdown-select" ${
              moveOptionsHTML ? "" : "disabled"
            }> <option value="">Move selected to...</option> ${moveOptionsHTML} </select>
                                <button class="btn btn-success" onclick="moveSelectedMembers('${groupName}')" ${
              moveOptionsHTML ? "" : "disabled"
            }><i class="fas fa-people-arrows"></i> Move</button>
                            </div>
                            ${
                              members.length > 0
                                ? memberHTML
                                : '<div class="text-center text-muted">No members in this group.</div>'
                            }
                        </div>
                    </div>`;
          })
          .join("");
      }

      function showTab(tabId, element) {
        document
          .querySelectorAll(".tab-pane")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(`${tabId}-tab`).classList.add("active");
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        element.classList.add("active");
      }
      function openModal(modalId) {
        document.getElementById(modalId).classList.add("show");
      }
      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove("show");
      }
      function openStudentModal() {
        document.getElementById("modalTitle").textContent = "Add New Student";
        document.getElementById("studentRoll").disabled = false;
        document.getElementById("studentRoll").value = "";
        document.getElementById("studentName").value = "";
        document.getElementById("editingRoll").value = "";
        openModal("studentModal");
      }
      function closeStudentModal() {
        closeModal("studentModal");
      }
      function openBulkAddModal() {
        openModal("bulkAddModal");
      }
      function closeBulkAddModal() {
        closeModal("bulkAddModal");
      }
      function openRandomizeModal() {
        openModal("randomizeModal");
      }
      function closeRandomizeModal() {
        closeModal("randomizeModal");
      }

      function saveStudent() {
        const roll = document.getElementById("studentRoll").value.trim();
        const name = document.getElementById("studentName").value.trim();
        const editingRoll = document.getElementById("editingRoll").value;
        if (!roll || !name)
          return showToast("Roll Number and Name are required.");
        if (editingRoll) {
          const student = allStudents.find((s) => s.roll === editingRoll);
          if (student) student.name = name;
          Object.values(allGroups).forEach((g) => {
            const m = g.find((m) => m.roll === editingRoll);
            if (m) m.name = name;
          });
          showToast("Student details updated.");
        } else {
          if (allStudents.some((s) => s.roll === roll))
            return showToast("Student with this Roll Number already exists.");
          allStudents.push({ roll, name });
          allStudents.sort((a, b) =>
            a.roll.localeCompare(b.roll, undefined, { numeric: true })
          );
          showToast("Student added successfully.");
        }
        refreshAll();
        closeStudentModal();
      }
      function importBulkStudents() {
        const data = document.getElementById("bulkStudentData").value.trim();
        if (!data) return showToast("Textarea is empty.");
        try {
          const newStudents = JSON.parse(data);
          if (!Array.isArray(newStudents))
            throw new Error("Input must be a JSON array.");
          let added = 0,
            skipped = 0;
          newStudents.forEach((s) => {
            if (
              s &&
              s.roll &&
              s.name &&
              !allStudents.some((es) => es.roll === s.roll.trim())
            ) {
              allStudents.push({ roll: s.roll.trim(), name: s.name.trim() });
              added++;
            } else {
              skipped++;
            }
          });
          if (added > 0)
            allStudents.sort((a, b) =>
              a.roll.localeCompare(b.roll, undefined, { numeric: true })
            );
          refreshAll();
          showToast(`Imported: ${added}, Skipped (duplicates): ${skipped}.`);
          closeBulkAddModal();
        } catch (error) {
          showToast(`Invalid JSON: ${error.message}`);
        }
      }
      function editStudent(roll) {
        const s = allStudents.find((st) => st.roll === roll);
        if (s) {
          document.getElementById("modalTitle").textContent = "Edit Student";
          document.getElementById("studentRoll").value = s.roll;
          document.getElementById("studentRoll").disabled = true;
          document.getElementById("studentName").value = s.name;
          document.getElementById("editingRoll").value = s.roll;
          openModal("studentModal");
        }
      }
      function deleteSelectedStudents() {
        if (selectedStudentRolls.size === 0)
          return showToast("No students selected.");
        if (
          !confirm(
            `Delete ${selectedStudentRolls.size} student(s)? This can be undone.`
          )
        )
          return;
        clearUndoState();
        const studentsToDelete = allStudents.filter((s) =>
          selectedStudentRolls.has(s.roll)
        );
        undoState = {
          type: "students",
          data: {
            students: studentsToDelete,
            groups: JSON.parse(JSON.stringify(allGroups)),
          },
        };
        allStudents = allStudents.filter(
          (s) => !selectedStudentRolls.has(s.roll)
        );
        Object.keys(allGroups).forEach((g) => {
          allGroups[g] = allGroups[g].filter(
            (m) => !selectedStudentRolls.has(m.roll)
          );
        });
        const count = selectedStudentRolls.size;
        selectedStudentRolls.clear();
        refreshAll();
        showToast(`${count} student(s) deleted.`, performUndo);
        undoTimeout = setTimeout(clearUndoState, 7000);
      }
      function toggleStudentSelection(roll) {
        handleStudentSelectionChange(null, roll);
      }
      function handleStudentSelectionChange(event, roll) {
        if (event) event.stopPropagation();
        const isChecked = selectedStudentRolls.has(roll);
        if (isChecked) selectedStudentRolls.delete(roll);
        else selectedStudentRolls.add(roll);
        updateSelectedCount();
        renderStudents();
        renderGroups();
      }
      function toggleSelectAllStudents() {
        const visibleStudents = allStudents.filter((s) => {
          const query = document
            .getElementById("searchStudent")
            .value.toLowerCase();
          return (
            s.name.toLowerCase().includes(query) ||
            s.roll.toLowerCase().includes(query)
          );
        });
        const allVisibleSelected = visibleStudents.every((s) =>
          selectedStudentRolls.has(s.roll)
        );
        visibleStudents.forEach((s) => {
          if (allVisibleSelected) selectedStudentRolls.delete(s.roll);
          else selectedStudentRolls.add(s.roll);
        });
        renderStudents();
      }
      function updateSelectedCount() {
        document.getElementById(
          "selectedCount"
        ).textContent = `(${selectedStudentRolls.size})`;
      }
      function exportSelectedStudents() {
        if (selectedStudentRolls.size === 0)
          return showToast("No students selected.");
        const text = Array.from(selectedStudentRolls)
          .map((roll) => {
            const s = allStudents.find((s) => s.roll === roll);
            return s ? `${s.roll} - ${s.name}` : "";
          })
          .join("\n");
        downloadFile("selected_students.txt", text);
      }
      function createGroup() {
        const name = document.getElementById("newGroupName").value.trim();
        if (!name) return showToast("Please enter a group name.");
        if (allGroups[name])
          return showToast("Group with this name already exists.");
        allGroups[name] = [];
        refreshAll();
        showToast(`Group "${name}" created.`);
        document.getElementById("newGroupName").value = "";
      }
      function assignSelectedToGroup() {
        const groupName = document.getElementById("groupSelect").value;
        if (!groupName) return showToast("Please select a group.");
        if (selectedStudentRolls.size === 0)
          return showToast("No students selected.");
        let assigned = 0;
        selectedStudentRolls.forEach((roll) => {
          if (!allGroups[groupName].some((m) => m.roll === roll)) {
            const s = allStudents.find((s) => s.roll === roll);
            if (s) {
              allGroups[groupName].push({ ...s, marker: "" });
              assigned++;
            }
          }
        });
        if (assigned > 0) {
          allGroups[groupName].sort((a, b) =>
            a.roll.localeCompare(b.roll, undefined, { numeric: true })
          );
          showToast(`${assigned} student(s) assigned to "${groupName}".`);
        } else {
          showToast(`Selected students already in "${groupName}".`);
        }
        selectedStudentRolls.clear();
        refreshAll();
      }
      function setMarker(groupName, roll, marker) {
        const member = allGroups[groupName]?.find((m) => m.roll === roll);
        if (member) {
          member.marker = member.marker === marker ? "" : marker;
          refreshAll();
          showToast("Marker updated.");
        }
      }
      function removeMember(groupName, roll) {
        if (!confirm(`Remove student from "${groupName}"? This can be undone.`))
          return;
        clearUndoState();
        const memberToRemove = allGroups[groupName].find(
          (m) => m.roll === roll
        );
        if (memberToRemove) {
          undoState = {
            type: "members",
            data: { groupName: groupName, members: [memberToRemove] },
          };
          allGroups[groupName] = allGroups[groupName].filter(
            (m) => m.roll !== roll
          );
          refreshAll();
          showToast(`Removed student from "${groupName}".`, performUndo);
          undoTimeout = setTimeout(clearUndoState, 7000);
        }
      }
      function removeSelectedMembers(groupName) {
        const rolls = allGroups[groupName]
          .filter((m) => selectedStudentRolls.has(m.roll))
          .map((m) => m.roll);
        if (rolls.length === 0)
          return showToast("No members selected to remove.", "warning");
        if (
          !confirm(
            `Remove ${rolls.length} member(s) from "${groupName}"? This can be undone.`
          )
        )
          return;
        clearUndoState();
        const membersToRemove = allGroups[groupName].filter((m) =>
          rolls.includes(m.roll)
        );
        undoState = {
          type: "members",
          data: { groupName: groupName, members: membersToRemove },
        };
        allGroups[groupName] = allGroups[groupName].filter(
          (m) => !rolls.includes(m.roll)
        );
        rolls.forEach((r) => selectedStudentRolls.delete(r));
        refreshAll();
        showToast(
          `${rolls.length} member(s) removed from "${groupName}".`,
          performUndo
        );
        undoTimeout = setTimeout(clearUndoState, 7000);
      }
      function moveSelectedMembers(groupName) {
        const targetGroupName = document.getElementById(
          `move-group-select-${groupName}`
        ).value;
        if (!targetGroupName)
          return showToast("Please select a destination group.", "warning");
        const rollsToMove = allGroups[groupName]
          .filter((m) => selectedStudentRolls.has(m.roll))
          .map((m) => m.roll);
        if (rollsToMove.length === 0)
          return showToast("No members selected to move.", "warning");
        let movedCount = 0;
        rollsToMove.forEach((roll) => {
          if (!allGroups[targetGroupName].some((m) => m.roll === roll)) {
            const memberToMove = allGroups[groupName].find(
              (m) => m.roll === roll
            );
            if (memberToMove) {
              allGroups[targetGroupName].push(memberToMove);
              movedCount++;
            }
          }
        });
        allGroups[groupName] = allGroups[groupName].filter(
          (m) => !rollsToMove.includes(m.roll)
        );
        allGroups[targetGroupName].sort((a, b) =>
          a.roll.localeCompare(b.roll, undefined, { numeric: true })
        );
        rollsToMove.forEach((r) => selectedStudentRolls.delete(r));
        refreshAll();
        if (movedCount > 0)
          showToast(
            `${movedCount} member(s) moved to "${targetGroupName}".`,
            "success"
          );
        else
          showToast(
            "Selected members are already in the target group.",
            "warning"
          );
      }
      function toggleSelectAllInGroup(groupName) {
        const membersInGroup = allGroups[groupName];
        const memberRolls = membersInGroup.map((m) => m.roll);
        const allSelected = memberRolls.every((r) =>
          selectedStudentRolls.has(r)
        );
        if (allSelected) {
          memberRolls.forEach((r) => selectedStudentRolls.delete(r));
        } else {
          memberRolls.forEach((r) => selectedStudentRolls.add(r));
        }
        renderGroups();
      }
      function deleteGroup(groupName) {
        if (!confirm(`Delete the group "${groupName}"? This can be undone.`))
          return;
        clearUndoState();
        undoState = {
          type: "group",
          data: { name: groupName, members: [...allGroups[groupName]] },
        };
        openGroups.delete(groupName);
        delete allGroups[groupName];
        refreshAll();
        showToast(`Group "${groupName}" deleted.`, performUndo);
        undoTimeout = setTimeout(clearUndoState, 7000);
      }
      function exportGroup(groupName) {
        const members = allGroups[groupName];
        if (!members || members.length === 0)
          return showToast(`Group "${groupName}" is empty.`);
        const text = members
          .map(
            (m) => `${m.roll} - ${m.name}${m.marker ? ` [${m.marker}]` : ""}`
          )
          .join("\n");
        downloadFile(
          `${groupName}_members.txt`,
          `Members of Group: ${groupName}\n\n${text}`
        );
      }
      function toggleCollapse(elementId) {
        document.getElementById(elementId).classList.toggle("collapsed");
      }
      function toggleGroupBody(groupName) {
        if (openGroups.has(groupName)) openGroups.delete(groupName);
        else openGroups.add(groupName);
        renderGroups();
      }
      function toggleAllGroupBodies() {
        const groupKeys = Object.keys(allGroups);
        if (groupKeys.length === 0) return;
        const shouldOpen = openGroups.size < groupKeys.length;
        if (shouldOpen) {
          groupKeys.forEach((key) => openGroups.add(key));
        } else {
          openGroups.clear();
        }
        renderGroups();
      }
      function updateAssignmentDropdown() {
        const select = document.getElementById("groupSelect");
        select.innerHTML =
          `<option value="">Select a group...</option>` +
          Object.keys(allGroups)
            .sort()
            .map((g) => `<option value="${g}">${g}</option>`)
            .join("");
      }
      function updateRandomizeLabel() {
        const method = document.querySelector(
          'input[name="randomizeMethod"]:checked'
        ).value;
        document.getElementById("randomizeValueLabel").textContent =
          method === "numGroups" ? "Number of Groups:" : "Students per Group:";
      }
      function generateRandomGroups() {
        const method = document.querySelector(
          'input[name="randomizeMethod"]:checked'
        ).value;
        const value = parseInt(document.getElementById("randomizeValue").value);
        const includeAssigned =
          document.getElementById("includeAssigned").checked;
        if (!value || value < 1)
          return showToast("Please enter a valid number.");
        let studentPool = [];
        if (includeAssigned) {
          studentPool = [...allStudents];
        } else {
          const assignedRolls = new Set(
            Object.values(allGroups)
              .flat()
              .map((m) => m.roll)
          );
          studentPool = allStudents.filter((s) => !assignedRolls.has(s.roll));
        }
        if (studentPool.length === 0)
          return showToast("No available students to randomize.");
        for (let i = studentPool.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [studentPool[i], studentPool[j]] = [studentPool[j], studentPool[i]];
        }
        let groupCounter = 1;
        while (allGroups[`Random Group ${groupCounter}`]) {
          groupCounter++;
        }
        if (method === "numGroups") {
          if (value > studentPool.length)
            return showToast(
              "Number of groups cannot exceed available students."
            );
          for (let i = 0; i < value; i++) {
            allGroups[`Random Group ${groupCounter + i}`] = [];
          }
          studentPool.forEach((student, index) => {
            allGroups[`Random Group ${groupCounter + (index % value)}`].push({
              ...student,
              marker: "",
            });
          });
        } else {
          for (let i = 0; i < studentPool.length; i += value) {
            const groupName = `Random Group ${groupCounter++}`;
            allGroups[groupName] = studentPool
              .slice(i, i + value)
              .map((s) => ({ ...s, marker: "" }));
          }
        }
        refreshAll();
        showToast("Random groups generated successfully!");
        closeRandomizeModal();
      }
      function downloadFile(filename, text) {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      }
      function backupAllData() {
        const data = { students: allStudents, groups: allGroups };
        downloadFile(
          `student_manager_backup_${
            new Date().toISOString().split("T")[0]
          }.json`,
          JSON.stringify(data, null, 2)
        );
        showToast("Full data backup created.");
      }
      function restoreData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (
              data &&
              Array.isArray(data.students) &&
              typeof data.groups === "object"
            ) {
              if (
                confirm(
                  "Restore data? This will overwrite all current students and groups."
                )
              ) {
                allStudents = data.students;
                allGroups = data.groups;
                selectedStudentRolls.clear();
                openGroups.clear();
                refreshAll();
                showToast("Data restored successfully!");
              }
            } else {
              throw new Error("Invalid backup file format.");
            }
          } catch (error) {
            showToast(`Restore failed: ${error.message}`);
          } finally {
            event.target.value = "";
          }
        };
        reader.readAsText(file);
      }
      document.addEventListener("DOMContentLoaded", () => {
        if (
          !localStorage.getItem("students") &&
          !localStorage.getItem("groups")
        ) {
          allStudents = [
            { roll: "1", name: "Abdul Kalam B" },
            { roll: "2", name: "Ajay D" },
            { roll: "3", name: "Akash Kumar R" },
            { roll: "4", name: "Arunachalam E" },
            { roll: "5", name: "Babu Esvaran C" },
            { roll: "6", name: "Daniel Raj R" },
          ];
          allGroups = {
            "Team Alpha": [
              { ...allStudents[0], marker: "" },
              { ...allStudents[1], marker: "" },
            ],
            "Team Beta": [{ ...allStudents[2], marker: "" }],
          };
          saveToStorage();
        }
        loadFromStorage();
        refreshAll();
        document
          .getElementById("searchStudent")
          .addEventListener("input", renderStudents);
      });
    </script>
  </body>
</html>
